{% extends "base.html" %}
{% block title %}对话 - Trial{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
{% block extra_css %}
.layout { display: flex; height: calc(100vh - 52px); }
.sidebar { width: 260px; min-width: 220px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 1px 0 4px rgba(0,0,0,0.04); transition: box-shadow 0.2s ease; }
.sidebar-title { padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: var(--muted); border-bottom: 1px solid var(--border); }
.sidebar-new { margin: 0.5rem; padding: 0.55rem 0.75rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.875rem; text-align: center; transition: background 0.2s ease, transform 0.15s ease; }
.sidebar-new:hover { background: var(--accent-hover); transform: translateY(-1px); }
.sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
.sidebar-item { display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; margin-bottom: 2px; transition: background 0.2s ease; }
.sidebar-item:hover { background: var(--bg); }
.sidebar-item.active { background: #dbeafe; color: var(--accent); }
.sidebar-item-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sidebar-item .btn-del { flex-shrink: 0; padding: 0.2rem 0.4rem; font-size: 0.75rem; background: transparent; border: none; color: var(--muted); cursor: pointer; border-radius: 4px; transition: background 0.2s, color 0.2s; }
.sidebar-item .btn-del:hover { background: #fecaca; color: #dc2626; }
.chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.toolbar { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; background: var(--card); }
.toolbar label { color: var(--muted); font-size: 0.875rem; }
.toolbar select { padding: 0.45rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 200px; transition: border-color 0.2s; }
.toolbar select:focus { outline: none; border-color: var(--accent); }
.toolbar-options { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.toolbar-check { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); cursor: pointer; }
.toolbar-check input { cursor: pointer; }
.toolbar-btn-toggle { padding: 0.45rem 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.875rem; cursor: pointer; transition: background 0.2s, border-color 0.2s, color 0.2s; }
.toolbar-btn-toggle:hover { border-color: var(--accent); color: var(--accent); }
.toolbar-btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
.toolbar-btn-toggle.active:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
.messages { flex: 1; overflow-y: auto; padding: 1rem; }
.msg { margin-bottom: 1rem; display: flex; flex-direction: column; align-items: flex-start; animation: msgIn 0.2s ease; }
@keyframes msgIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
.msg.user { align-items: flex-end; }
.msg.user .bubble { background: var(--accent); color: white; padding: 0.75rem 1rem; border-radius: 12px 12px 4px 12px; max-width: min(85%, 560px); width: fit-content; }
.msg.assistant .bubble { background: var(--card); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: 12px 12px 12px 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); max-width: min(85%, 560px); width: fit-content; }
.msg .role { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem; }
.msg.assistant .bubble pre { background: var(--bg); padding: 0.75rem; border-radius: 6px; overflow-x: auto; font-size: 0.875rem; }
.msg.assistant .bubble code { background: var(--bg); padding: 0.1em 0.3em; border-radius: 4px; font-size: 0.9em; }
.msg.assistant .bubble pre code { padding: 0; }
/* 操作步骤子信息栏（类似 Cursor 的步骤展示） */
.steps-panel { width: 100%; margin-bottom: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); overflow: hidden; }
.step-item { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
.step-item:last-child { border-bottom: none; }
.step-item.running .step-icon { color: var(--accent); }
.step-item.done .step-icon { color: #059669; }
.step-icon { flex-shrink: 0; width: 1.2rem; text-align: center; }
.step-body { flex: 1; min-width: 0; }
.step-name { color: var(--text); font-weight: 500; margin-bottom: 0.15rem; }
.step-result { color: var(--muted); font-size: 0.75rem; white-space: pre-wrap; word-break: break-word; max-height: 4em; overflow-y: auto; }
.stream-content { margin-top: 0; }
.input-row { padding: 1rem; border-top: 1px solid var(--border); background: var(--card); display: flex; gap: 0.5rem; }
.input-row input { flex: 1; padding: 0.65rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); transition: border-color 0.2s; }
.input-row input:focus { outline: none; border-color: var(--accent); }
.input-row button { padding: 0.65rem 1.25rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s ease; }
.input-row button:hover:not(:disabled) { background: var(--accent-hover); }
.input-row button:disabled { opacity: 0.5; cursor: not-allowed; }
.error { color: #dc2626; padding: 0 1rem 0.5rem; font-size: 0.875rem; }

/* 删除确认：背景虚化子页面 */
.confirm-overlay { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s; }
.confirm-overlay.show { opacity: 1; visibility: visible; }
.confirm-card { background: var(--card); border-radius: 12px; padding: 1.5rem; max-width: 320px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transform: scale(0.95); transition: transform 0.2s ease; }
.confirm-overlay.show .confirm-card { transform: scale(1); }
.confirm-card .confirm-title { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; }
.confirm-card .confirm-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.25rem; }
.confirm-card .confirm-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: none; transition: background 0.2s; }
.confirm-card .confirm-btn-primary { background: var(--accent); color: white; }
.confirm-card .confirm-btn-primary:hover { background: var(--accent-hover); }
.confirm-card .confirm-btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.confirm-card .confirm-btn-secondary:hover { background: var(--border); }
{% endblock %}
{% block content %}
<div class="layout">
    <aside class="sidebar">
        <div class="sidebar-title">对话</div>
        <button type="button" class="sidebar-new" id="newChat">+ 新对话</button>
        <div class="sidebar-list" id="conversationList"></div>
    </aside>
    <div class="chat-main">
        <div class="toolbar">
            <label for="modelOption">模型</label>
            <select id="modelOption"></select>
            <span class="toolbar-options" id="toolbarOptions">
                <label class="toolbar-check" id="wrapUtcpToggle" style="display: none;"><input type="checkbox" id="utcpToolsCheck" checked> 启用自动化工作流(UTCP)</label>
                <button type="button" class="toolbar-btn-toggle" id="btnDeepThinking" style="display: none;">启用深度思考</button>
            </span>
        </div>
        <div class="messages" id="messages"></div>
        <div class="input-row">
            <input type="text" id="input" placeholder="输入消息...（支持多轮对话记忆）" autocomplete="off">
            <button type="button" id="send">发送</button>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <div class="confirm-overlay" id="confirmOverlay" aria-hidden="true">
        <div class="confirm-card" id="confirmCard">
            <p class="confirm-title" id="confirmTitle">确定删除该对话？</p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn confirm-btn-primary" id="confirmOk">确定</button>
                <button type="button" class="confirm-btn confirm-btn-secondary" id="confirmCancel">取消</button>
            </div>
        </div>
    </div>
</div>
<script>
(function() {
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const modelOptionEl = document.getElementById('modelOption');
    const btnDeepThinkingEl = document.getElementById('btnDeepThinking');
    const errorEl = document.getElementById('error');
    const conversationListEl = document.getElementById('conversationList');
    const newChatBtn = document.getElementById('newChat');

    let providers = {{ providers | tojson }};
    let currentConversationId = null;
    let messages = [];

    function showError(msg) {
        errorEl.textContent = msg || '';
        errorEl.style.display = msg ? 'block' : 'none';
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true });
            return marked.parse(text || '');
        }
        return escapeHtml(text).replace(/\n/g, '<br>');
    }

    function fillModelOptions() {
        const curIdx = modelOptionEl.value === '' ? -1 : parseInt(modelOptionEl.value, 10);
        modelOptionEl.innerHTML = '';
        providers.forEach(function(p, i) {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = p.label;
            if (i === curIdx || (curIdx < 0 && i === 0)) opt.selected = true;
            modelOptionEl.appendChild(opt);
        });
        updateToolbarOptionsVisibility();
    }

    var deepThinkingEnabled = false;
    var utcpToolsChecked = true;
    function updateToolbarOptionsVisibility() {
        const idx = parseInt(modelOptionEl.value, 10);
        const p = providers[idx];
        const wrapUtcp = document.getElementById('wrapUtcpToggle');
        if (!p) {
            btnDeepThinkingEl.style.display = 'none';
            if (wrapUtcp) wrapUtcp.style.display = 'none';
            return;
        }
        btnDeepThinkingEl.style.display = p.support_deep_thinking ? 'inline-block' : 'none';
        if (wrapUtcp) wrapUtcp.style.display = (utcpPluginEnabled && p.support_function_calling) ? 'inline-flex' : 'none';
        if (!p.support_deep_thinking) {
            deepThinkingEnabled = false;
            btnDeepThinkingEl.classList.remove('active');
        }
    }

    var utcpPluginEnabled = true;
    function refreshModelsThenUpdateUI() {
        fetch('/api/models').then(function(r) { return r.json(); }).then(function(data) {
            if (data.providers && data.providers.length) providers = data.providers;
            else if (data.models && data.models.length) providers = data.models;
            utcpPluginEnabled = data.utcp_plugin_enabled !== false;
            fillModelOptions();
        }).catch(function() {
            fillModelOptions();
        });
    }

    modelOptionEl.addEventListener('change', updateToolbarOptionsVisibility);

    btnDeepThinkingEl.addEventListener('click', function() {
        if (!providers[parseInt(modelOptionEl.value, 10)] || !providers[parseInt(modelOptionEl.value, 10)].support_deep_thinking) return;
        deepThinkingEnabled = !deepThinkingEnabled;
        btnDeepThinkingEl.classList.toggle('active', deepThinkingEnabled);
    });

    fillModelOptions();
    refreshModelsThenUpdateUI();

    function addMessage(role, content, options) {
        options = options || {};
        const div = document.createElement('div');
        div.className = 'msg ' + role;
        div.dataset.role = role;
        if (options.id) div.id = options.id;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (role === 'user') {
            bubble.textContent = content;
        } else if (options.forStreaming) {
            var stepsPanel = document.createElement('div');
            stepsPanel.className = 'steps-panel';
            stepsPanel.id = 'streaming-steps';
            var contentWrap = document.createElement('div');
            contentWrap.className = 'stream-content';
            contentWrap.id = 'streaming-content';
            bubble.appendChild(stepsPanel);
            bubble.appendChild(contentWrap);
        } else {
            bubble.innerHTML = renderMarkdown(content);
        }
        const roleLabel = role === 'user' ? '你' : (options.model_label || '助手');
        div.innerHTML = '';
        var roleEl = document.createElement('div');
        roleEl.className = 'role';
        roleEl.textContent = roleLabel;
        div.appendChild(roleEl);
        div.appendChild(bubble);
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return bubble;
    }

    function renderConversationList() {
        fetch('/api/conversations')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                conversationListEl.innerHTML = '';
                (data.conversations || []).forEach(function(c) {
                    const wrap = document.createElement('div');
                    wrap.className = 'sidebar-item' + (c.id === currentConversationId ? ' active' : '');
                    wrap.dataset.id = c.id;
                    const title = document.createElement('span');
                    title.className = 'sidebar-item-title';
                    title.textContent = c.title || '新对话';
                    const btnDel = document.createElement('button');
                    btnDel.type = 'button';
                    btnDel.className = 'btn-del';
                    btnDel.textContent = '删除';
                    btnDel.setAttribute('aria-label', '删除');
                    wrap.appendChild(title);
                    wrap.appendChild(btnDel);
                    wrap.addEventListener('click', function(ev) {
                        if (ev.target === btnDel) return;
                        loadConversation(c.id);
                    });
                    btnDel.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        showConfirmDelete(c.id);
                    });
                    conversationListEl.appendChild(wrap);
                });
            })
            .catch(function() {});
    }

    function loadConversation(cid) {
        currentConversationId = cid;
        messages = [];
        messagesEl.innerHTML = '';
        fetch('/api/conversations/' + encodeURIComponent(cid))
            .then(function(r) { return r.json(); })
            .then(function(conv) {
                if (!conv.messages) return;
                conv.messages.forEach(function(m) {
                    addMessage(m.role, m.content || '', { model_label: m.model_label });
                    messages.push({ role: m.role, content: m.content || '', model_label: m.model_label });
                });
                renderConversationList();
            })
            .catch(function() { renderConversationList(); });
    }

    function startNewChat() {
        currentConversationId = null;
        messages = [];
        messagesEl.innerHTML = '';
        renderConversationList();
    }

    var pendingDeleteId = null;
    var confirmOverlay = document.getElementById('confirmOverlay');
    var confirmCard = document.getElementById('confirmCard');
    var confirmOk = document.getElementById('confirmOk');
    var confirmCancel = document.getElementById('confirmCancel');

    function showConfirmDelete(cid) {
        pendingDeleteId = cid;
        confirmOverlay.classList.add('show');
        confirmOverlay.setAttribute('aria-hidden', 'false');
    }
    function hideConfirm() {
        pendingDeleteId = null;
        confirmOverlay.classList.remove('show');
        confirmOverlay.setAttribute('aria-hidden', 'true');
    }
    function doConfirmDelete() {
        if (!pendingDeleteId) return;
        var cid = pendingDeleteId;
        hideConfirm();
        fetch('/api/conversations/' + encodeURIComponent(cid), { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function() {
                if (currentConversationId === cid) startNewChat();
                else currentConversationId = null;
                renderConversationList();
            });
    }
    confirmOk.addEventListener('click', doConfirmDelete);
    confirmCancel.addEventListener('click', hideConfirm);
    confirmOverlay.addEventListener('click', function(ev) {
        if (ev.target === confirmOverlay) hideConfirm();
    });
    confirmCard.addEventListener('click', function(ev) { ev.stopPropagation(); });
    document.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape' && confirmOverlay.classList.contains('show')) hideConfirm();
    });

    newChatBtn.addEventListener('click', startNewChat);
    renderConversationList();

    function getCurrentProviderAndModel() {
        var idx = parseInt(modelOptionEl.value, 10);
        var p = providers[idx];
        if (!p) return { providerId: '', model: '', useUtcpTools: false, useDeepThinking: false };
        var utcpCheckEl = document.getElementById('utcpToolsCheck');
        return {
            providerId: p.provider_id,
            model: p.model,
            useUtcpTools: utcpPluginEnabled && p.support_function_calling && (utcpCheckEl ? utcpCheckEl.checked : true),
            useDeepThinking: p.support_deep_thinking && deepThinkingEnabled
        };
    }

    function sendMessage() {
        const text = (inputEl.value || '').trim();
        if (!text) return;
        var sel = getCurrentProviderAndModel();
        var providerId = sel.providerId;
        var model = sel.model;
        if (!providerId || !model) {
            showError('请先选择模型');
            return;
        }
        messages.push({ role: 'user', content: text });
        addMessage('user', text);
        inputEl.value = '';
        sendBtn.disabled = true;
        showError('');

        var currentLabel = (providers[parseInt(modelOptionEl.value, 10)] || {}).label || '助手';
        var useUtcpStream = sel.useUtcpTools;
        var assistantBubble = addMessage('assistant', '', { id: 'streaming-msg', model_label: currentLabel, forStreaming: useUtcpStream });
        var streamContent = '';
        var stepsPanel = useUtcpStream ? document.getElementById('streaming-steps') : null;
        var contentWrap = useUtcpStream ? document.getElementById('streaming-content') : null;

        fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                provider_id: providerId,
                model: model,
                messages: messages,
                conversation_id: currentConversationId,
                use_utcp_tools: sel.useUtcpTools,
                use_deep_thinking: sel.useDeepThinking
            })
        })
        .then(function(response) {
            if (!response.ok) return response.json().then(function(d) { throw new Error(d.error || '请求失败'); });
            return response.body.getReader();
        })
        .then(function(reader) {
            var decoder = new TextDecoder();
            var buffer = '';
            function read() {
                return reader.read().then(function(result) {
                    if (result.done) return;
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    lines.forEach(function(line) {
                        if (line.startsWith('data: ')) {
                            try {
                                var data = JSON.parse(line.slice(6));
                                if (data.type === 'tool_call' && stepsPanel) {
                                    var step = document.createElement('div');
                                    step.className = 'step-item running';
                                    step.dataset.toolCallId = data.tool_call_id || '';
                                    step.innerHTML = '<span class="step-icon">⏳</span><div class="step-body"><div class="step-name">调用 ' + escapeHtml(data.name || '') + '(' + escapeHtml((data.arguments_preview || '').replace(/^\{|\}$/g, '')) + ')</div><div class="step-result"></div></div>';
                                    stepsPanel.appendChild(step);
                                    messagesEl.scrollTop = messagesEl.scrollHeight;
                                } else if (data.type === 'tool_result' && stepsPanel) {
                                    var tid = data.tool_call_id || '';
                                    var stepEl = null;
                                    stepsPanel.querySelectorAll('.step-item').forEach(function(s) { if (s.dataset.toolCallId === tid) stepEl = s; });
                                    if (stepEl) {
                                        stepEl.classList.remove('running');
                                        stepEl.classList.add('done');
                                        var icon = stepEl.querySelector('.step-icon');
                                        if (icon) icon.textContent = '✓';
                                        var res = stepEl.querySelector('.step-result');
                                        if (res) res.textContent = (data.result_summary || data.result_full || '').substring(0, 400);
                                    }
                                    messagesEl.scrollTop = messagesEl.scrollHeight;
                                } else if (data.content !== undefined) {
                                    streamContent += (data.content || '');
                                    if (contentWrap) contentWrap.innerHTML = renderMarkdown(streamContent);
                                    else assistantBubble.innerHTML = renderMarkdown(streamContent);
                                    messagesEl.scrollTop = messagesEl.scrollHeight;
                                }
                                if (data.conversation_id) currentConversationId = data.conversation_id;
                                if (data.error) showError(data.error);
                            } catch (e) {}
                        }
                    });
                    return read();
                });
            }
            return read();
        })
        .then(function() {
            if (stepsPanel && stepsPanel.querySelectorAll('.step-item').length === 0) stepsPanel.style.display = 'none';
            messages.push({ role: 'assistant', content: streamContent, model_label: currentLabel });
            var el = document.getElementById('streaming-msg');
            if (el) el.id = '';
            renderConversationList();
        })
        .catch(function(e) {
            showError(e.message || '请求失败');
            var el = document.getElementById('streaming-msg');
            if (el) el.remove();
            messages.pop();
        })
        .finally(function() {
            sendBtn.disabled = false;
        });
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
})();
</script>
{% endblock %}
