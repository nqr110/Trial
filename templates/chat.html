{% extends "base.html" %}
{% block title %}å¯¹è¯ - Trial{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
{% block extra_css %}
.layout { display: flex; height: calc(100vh - 52px); }
.sidebar { width: 260px; min-width: 220px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 1px 0 4px rgba(0,0,0,0.04); transition: box-shadow 0.2s ease; }
.sidebar-title { padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; color: var(--muted); border-bottom: 1px solid var(--border); }
.sidebar-new { margin: 0.5rem; padding: 0.55rem 0.75rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.875rem; text-align: center; transition: background 0.2s ease, transform 0.15s ease; }
.sidebar-new:hover { background: var(--accent-hover); transform: translateY(-1px); }
.sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
.sidebar-item { display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; margin-bottom: 2px; transition: background 0.2s ease; }
.sidebar-item:hover { background: var(--bg); }
.sidebar-item.active { background: #dbeafe; color: var(--accent); }
.sidebar-item-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sidebar-item .btn-del { flex-shrink: 0; padding: 0.2rem 0.4rem; font-size: 0.75rem; background: transparent; border: none; color: var(--muted); cursor: pointer; border-radius: 4px; transition: background 0.2s, color 0.2s; }
.sidebar-item .btn-del:hover { background: #fecaca; color: #dc2626; }
.chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.toolbar { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; background: var(--card); }
.toolbar label { color: var(--muted); font-size: 0.875rem; }
.toolbar select { padding: 0.45rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 200px; transition: border-color 0.2s; }
.toolbar select:focus { outline: none; border-color: var(--accent); }
.toolbar-options { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.toolbar-check { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); cursor: pointer; }
.toolbar-check input { cursor: pointer; }
.toolbar-btn-toggle { padding: 0.45rem 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.875rem; cursor: pointer; transition: background 0.2s, border-color 0.2s, color 0.2s; }
.toolbar-btn-toggle:hover { border-color: var(--accent); color: var(--accent); }
.toolbar-btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
.toolbar-btn-toggle.active:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
.messages { flex: 1; min-height: 0; overflow-y: auto; padding: 1rem; }
.msg { margin-bottom: 1rem; display: flex; flex-direction: column; align-items: flex-start; animation: msgIn 0.2s ease; }
@keyframes msgIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
.msg.user { align-items: flex-end; }
.msg.user .bubble { background: var(--accent); color: white; padding: 0.75rem 1rem; border-radius: 12px 12px 4px 12px; max-width: min(85%, 560px); width: fit-content; }
.msg.assistant .bubble { background: var(--card); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: 12px 12px 12px 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); max-width: min(92%, 720px); width: fit-content; }
.msg .role { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem; }
.msg.assistant .bubble pre { background: var(--bg); padding: 0.75rem; border-radius: 6px; overflow-x: auto; font-size: 0.875rem; }
.msg.assistant .bubble code { background: var(--bg); padding: 0.1em 0.3em; border-radius: 4px; font-size: 0.9em; }
.msg.assistant .bubble pre code { padding: 0; }
/* æ“ä½œæ­¥éª¤å­ä¿¡æ¯æ ï¼ˆç±»ä¼¼ Cursorï¼‰ï¼šæ•´ä½“å¯æ”¶èµ·ï¼›æ¯æ¡å‘½ä»¤ç‹¬ç«‹å¯å±•å¼€ï¼Œå±•å¼€åä¸é™åˆ¶é«˜åº¦ */
.steps-panel { width: 100%; margin-bottom: 0.5rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); flex-shrink: 0; }
.steps-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 0.4rem 0.75rem; font-size: 0.8rem; color: var(--muted); cursor: pointer; user-select: none; gap: 0.5rem; }
.steps-panel-header:hover { color: var(--text); background: rgba(0,0,0,0.03); border-radius: 8px 8px 0 0; }
.steps-panel-total-time { margin-left: auto; font-size: 0.75rem; color: var(--muted); flex-shrink: 0; }
.steps-panel-arrow { font-size: 0.7rem; transition: transform 0.2s; flex-shrink: 0; }
.steps-panel.collapsed .steps-panel-arrow { transform: rotate(-90deg); }
.steps-panel-body { overflow: visible; }
.steps-panel.collapsed .steps-panel-body { display: none; }
/* æ¯æ¡æ­¥éª¤ï¼šä¸¥æ ¼ä¸Šä¸‹ä¸¤æ â€”â€”ä¸Šä¸ºæ ‡é¢˜è¡Œï¼ˆå•è¡Œï¼‰ï¼Œä¸‹ä¸ºç»“æœåŒºï¼ˆå æ»¡æ•´è¡Œå®½ï¼‰ */
.steps-panel-body { display: flex; flex-direction: column; width: 100%; }
.step-item { border-bottom: 1px solid var(--border); font-size: 0.8rem; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; }
.step-item:last-child { border-bottom: none; }
.step-item.running .step-icon { color: var(--accent); }
.step-item.done .step-icon { color: #059669; }
.step-item.failed .step-icon { color: #dc2626; }
.step-item.failed .step-name { color: #b91c1c; }
.steps-panel-phase { font-size: 0.75rem; color: var(--accent); padding: 0.3rem 0.75rem; background: rgba(59, 130, 246, 0.08); border-radius: 6px; margin-bottom: 0.35rem; display: none; align-items: center; justify-content: space-between; gap: 0.5rem; }
.steps-panel-phase.show { display: flex; }
.step-elapsed { font-size: 0.7rem; color: var(--muted); font-weight: normal; }
.step-item-header { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; user-select: none; flex-shrink: 0; width: 100%; box-sizing: border-box; }
.step-item-header:hover { background: rgba(0,0,0,0.03); }
.step-item.collapsed .step-item-body { display: none; }
.step-item-body { display: block; padding: 0.5rem 0.75rem 0.75rem; width: 100%; box-sizing: border-box; min-width: 0; border-top: 1px solid var(--border); }
.step-icon { flex-shrink: 0; width: 1.2rem; text-align: center; }
.step-body { flex: 1; min-width: 0; overflow: hidden; display: flex; flex-direction: column; align-items: flex-start; gap: 0.25rem; }
.step-name { color: var(--text); font-weight: 500; display: flex; align-items: center; flex-wrap: nowrap; gap: 0.35rem; min-width: 0; max-width: 100%; }
.step-call-label { white-space: nowrap; flex-shrink: 0; }
.step-elapsed { margin-left: 0; margin-top: 0; }
.step-tool-pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: rgba(0,0,0,0.07); color: var(--text); }
.step-tool-run_shell { background: #dbeafe; color: #1e40af; }
.step-tool-preview_web_page { background: #d1fae5; color: #065f46; }
.step-tool-read_file { background: #fef3c7; color: #92400e; }
.step-tool-write_file { background: #e0e7ff; color: #3730a3; }
.step-tool-list_dir { background: #fce7f3; color: #9d174d; }
.step-arg-pill { display: inline-block; max-width: 100%; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; background: rgba(0,0,0,0.06); color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.step-item-long { background: rgba(220, 38, 38, 0.06); }
.step-item-body-title { font-size: 0.8rem; font-weight: 500; color: var(--text); margin-bottom: 0.35rem; word-break: break-word; }
.steps-panel-phase-timer { margin-left: auto; font-size: 0.7rem; color: var(--muted); }
.step-result { color: var(--muted); font-size: 0.75rem; white-space: pre-wrap; word-break: break-word; display: block; width: 100%; max-width: 100%; overflow-x: auto; box-sizing: border-box; }
/* æœ‰æ–°çš„ä»»åŠ¡ä¿¡æ¯æç¤ºæ¡ */
.messages-new-hint { position: absolute; bottom: 0.5rem; left: 50%; transform: translateX(-50%); padding: 0.4rem 0.75rem; background: var(--accent); color: white; border-radius: 8px; font-size: 0.8rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; display: none; }
.messages-new-hint.show { display: inline-block; }
.messages-wrap { position: relative; flex: 1; display: flex; flex-direction: column; min-height: 0; }
.stream-content { margin-top: 0.25rem; min-height: 1em; flex: 1; min-width: 0; }
.plan-panel { margin-bottom: 0.5rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.02); padding: 0.5rem 0.75rem; }
.plan-panel-title { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.35rem; font-weight: 600; }
.plan-panel-body { font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.plan-panel-body p { margin: 0.25em 0; }
.msg-del-turn-wrap { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); }
.msg-del-turn { font-size: 0.75rem; color: var(--muted); background: none; border: none; cursor: pointer; padding: 0; }
.msg-del-turn:hover { color: #dc2626; }
.web-preview-panel { margin-bottom: 0.5rem; border: 1px solid var(--border); border-radius: 8px; background: var(--card); overflow: hidden; }
.web-preview-panel.collapsed .web-preview-iframe-wrap { display: none; }
.web-preview-header { padding: 0.4rem 0.75rem; font-size: 0.8rem; color: var(--muted); background: rgba(0,0,0,0.03); cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; }
.web-preview-header:hover { color: var(--text); }
.web-preview-header .web-preview-open-tab { margin-left: auto; padding-left: 0.5rem; font-size: 0.75rem; color: var(--accent); cursor: pointer; text-decoration: none; }
.web-preview-header .web-preview-open-tab:hover { text-decoration: underline; }
.web-preview-iframe-wrap { width: 100%; height: 320px; min-height: 200px; background: var(--bg); }
.web-preview-iframe { width: 100%; height: 100%; border: none; display: block; }
.msg.assistant .bubble { display: flex; flex-direction: column; }
.input-wrap { padding: 1rem; border-top: 1px solid var(--border); background: var(--card); }
.input-wrap.drag-over { background: rgba(59, 130, 246, 0.08); outline: 2px dashed var(--accent); outline-offset: -2px; }
.input-attachments { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.5rem; min-height: 0; }
.input-attachment-card { position: relative; width: 72px; flex-shrink: 0; }
.input-attachment-card .card-box { width: 72px; height: 72px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); overflow: hidden; display: flex; align-items: center; justify-content: center; }
.input-attachment-card .card-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
.input-attachment-card .card-box .card-icon { font-size: 1.75rem; color: var(--muted); line-height: 1; }
.input-attachment-card .card-name { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 72px; }
.input-attachment-card .card-remove { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff; border: none; cursor: pointer; font-size: 0.9rem; line-height: 1; display: flex; align-items: center; justify-content: center; padding: 0; }
.input-attachment-card .card-remove:hover { background: #dc2626; }
.input-row { display: flex; gap: 0.5rem; align-items: flex-end; }
.input-row .input-text-wrap { flex: 1; min-width: 0; }
.input-row textarea.chat-input { width: 100%; min-height: 44px; max-height: 200px; padding: 0.65rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; font-size: 1rem; resize: none; transition: border-color 0.2s; box-sizing: border-box; }
.input-row textarea.chat-input:focus { outline: none; border-color: var(--accent); }
.input-row .btn-upload { flex-shrink: 0; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-size: 0.875rem; cursor: pointer; transition: border-color 0.2s, color 0.2s; }
.input-row .btn-upload:hover { border-color: var(--accent); color: var(--accent); }
.input-row button[type="button"]#send { flex-shrink: 0; padding: 0.65rem 1.25rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s ease; }
.input-row button[type="button"]#send:hover:not(:disabled) { background: var(--accent-hover); }
.input-row button[type="button"]#send:disabled { opacity: 0.5; cursor: not-allowed; }
.error { color: #dc2626; padding: 0 1rem 0.5rem; font-size: 0.875rem; white-space: pre-wrap; }

/* åˆ é™¤ç¡®è®¤ï¼šèƒŒæ™¯è™šåŒ–å­é¡µé¢ */
.confirm-overlay { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s; }
.confirm-overlay.show { opacity: 1; visibility: visible; }
.confirm-card { background: var(--card); border-radius: 12px; padding: 1.5rem; max-width: 320px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transform: scale(0.95); transition: transform 0.2s ease; }
.confirm-overlay.show .confirm-card { transform: scale(1); }
.confirm-card .confirm-title { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; }
.confirm-card .confirm-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.25rem; }
.confirm-card .confirm-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: none; transition: background 0.2s; }
.confirm-card .confirm-btn-primary { background: var(--accent); color: white; }
.confirm-card .confirm-btn-primary:hover { background: var(--accent-hover); }
.confirm-card .confirm-btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.confirm-card .confirm-btn-secondary:hover { background: var(--border); }
.chat-empty-hint { padding: 2rem; text-align: center; color: var(--muted); font-size: 0.9rem; }
{% endblock %}
{% block content %}
<div class="layout">
    <aside class="sidebar">
        <div class="sidebar-title">å¯¹è¯</div>
        <button type="button" class="sidebar-new" id="newChat">+ æ–°å¯¹è¯</button>
        <div class="sidebar-list" id="conversationList"></div>
    </aside>
    <div class="chat-main">
        <div class="toolbar">
            <label for="modelOption">æ¨¡å‹</label>
            <select id="modelOption"></select>
            <span class="toolbar-options" id="toolbarOptions">
                <button type="button" class="toolbar-btn-toggle" id="btnDeepThinking" style="display: none;">å¯ç”¨æ·±åº¦æ€è€ƒ</button>
            </span>
        </div>
        <div class="messages-wrap">
            <div class="messages" id="messages"></div>
            <div class="messages-new-hint" id="messagesNewHint">æœ‰æ–°çš„ä»»åŠ¡ä¿¡æ¯ï¼Œç‚¹å‡»æŸ¥çœ‹</div>
        </div>
        <div class="input-wrap" id="inputWrap">
            <input type="file" id="fileInput" multiple style="display: none;">
            <div class="input-attachments" id="attachmentChips"></div>
            <div class="input-row">
                <button type="button" class="btn-upload" id="btnUpload">ä¸Šä¼ æ–‡ä»¶</button>
                <div class="input-text-wrap"><textarea id="input" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæ”¯æŒå¤šè½®å¯¹è¯è®°å¿†ï¼‰Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ" autocomplete="off" rows="1"></textarea></div>
                <button type="button" id="send">å‘é€</button>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <div class="confirm-overlay" id="confirmOverlay" aria-hidden="true">
        <div class="confirm-card" id="confirmCard">
            <p class="confirm-title" id="confirmTitle">ç¡®å®šåˆ é™¤è¯¥å¯¹è¯ï¼Ÿ</p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn confirm-btn-primary" id="confirmOk">ç¡®å®š</button>
                <button type="button" class="confirm-btn confirm-btn-secondary" id="confirmCancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>
<script>
(function() {
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const modelOptionEl = document.getElementById('modelOption');
    const btnDeepThinkingEl = document.getElementById('btnDeepThinking');
    const errorEl = document.getElementById('error');
    const conversationListEl = document.getElementById('conversationList');
    const newChatBtn = document.getElementById('newChat');

    // æ¶æ„è¯´æ˜ï¼šä¸ AI çš„å¯¹è¯ç”±æœåŠ¡ç«¯ç»´æŒã€‚å®¢æˆ·ç«¯åªè¯·æ±‚æœ¬åº”ç”¨ /api/chat/streamï¼ŒæœåŠ¡ç«¯å†è¯·æ±‚ AI æœåŠ¡å•†å¹¶å†™å…¥ data/conversations.jsonã€‚
    // å®¢æˆ·ç«¯ä»…ä¿å­˜ã€Œå½“å‰æŸ¥çœ‹çš„å¯¹è¯ idã€å’Œè‰ç¨¿ï¼›æ¶ˆæ¯ä¸åˆ—è¡¨ä¸€å¾‹ä»æœåŠ¡ç«¯æ‹‰å–å¹¶ä¿¡ä»»æœåŠ¡ç«¯æ•°æ®ã€‚
    let providers = {{ providers | tojson }};
    let currentConversationId = null;
    let messages = [];
    var conversationLockedModel = null;
    var conversationLockModelEnabled = true;
    var attachmentList = [];
    const fileInputEl = document.getElementById('fileInput');
    const btnUploadEl = document.getElementById('btnUpload');
    const attachmentChipsEl = document.getElementById('attachmentChips');
    const inputWrapEl = document.getElementById('inputWrap');
    const messagesNewHintEl = document.getElementById('messagesNewHint');

    function isMessagesAtBottom() {
        var el = messagesEl;
        return el.scrollHeight - el.scrollTop - el.clientHeight < 40;
    }
    function scrollMessagesToBottom() {
        messagesEl.scrollTop = messagesEl.scrollHeight;
        if (messagesNewHintEl) messagesNewHintEl.classList.remove('show');
    }
    function onTaskInfoUpdate() {
        if (isMessagesAtBottom()) scrollMessagesToBottom();
        else if (messagesNewHintEl) messagesNewHintEl.classList.add('show');
    }
    if (messagesNewHintEl) {
        messagesNewHintEl.addEventListener('click', scrollMessagesToBottom);
    }
    messagesEl.addEventListener('scroll', function() {
        if (isMessagesAtBottom() && messagesNewHintEl) messagesNewHintEl.classList.remove('show');
    });

    function getIconForFile(name, type) {
        var ext = (name || '').split('.').pop().toLowerCase();
        if ((type || '').indexOf('image/') === 0) return 'ğŸ–¼';
        if ((type || '').indexOf('video/') === 0) return 'ğŸ¬';
        if ((type || '').indexOf('audio/') === 0) return 'ğŸµ';
        if (ext === 'pdf') return 'ğŸ“•';
        if (['zip','rar','7z','tar','gz'].indexOf(ext) >= 0) return 'ğŸ“¦';
        if (['doc','docx'].indexOf(ext) >= 0) return 'ğŸ“˜';
        if (['xls','xlsx'].indexOf(ext) >= 0) return 'ğŸ“—';
        if (['ppt','pptx'].indexOf(ext) >= 0) return 'ğŸ“™';
        if (['js','ts','py','java','c','cpp','go','rs','html','css','json','md'].indexOf(ext) >= 0) return 'ğŸ“';
        if (['txt','log','csv'].indexOf(ext) >= 0) return 'ğŸ“ƒ';
        return 'ğŸ“„';
    }

    function renderAttachmentChips() {
        attachmentChipsEl.innerHTML = '';
        attachmentList.forEach(function(item, i) {
            var card = document.createElement('div');
            card.className = 'input-attachment-card';
            var name = item.name || item.path.replace(/^.*\//, '');
            var icon = getIconForFile(name, item.type);
            var boxContent = item.previewUrl
                ? '<img src="' + escapeHtml(item.previewUrl) + '" alt="">'
                : '<span class="card-icon">' + icon + '</span>';
            card.innerHTML = '<div class="card-box">' + boxContent + '</div><div class="card-name" title="' + escapeHtml(name) + '">' + escapeHtml(name) + '</div><button type="button" class="card-remove" data-index="' + i + '" aria-label="ç§»é™¤">Ã—</button>';
            card.querySelector('.card-remove').addEventListener('click', function(e) {
                e.stopPropagation();
                var idx = parseInt(this.getAttribute('data-index'), 10);
                var it = attachmentList[idx];
                if (it && it.previewUrl) URL.revokeObjectURL(it.previewUrl);
                attachmentList.splice(idx, 1);
                renderAttachmentChips();
            });
            attachmentChipsEl.appendChild(card);
        });
    }

    function uploadFiles(files) {
        if (!files || !files.length) return;
        var fd = new FormData();
        for (var i = 0; i < files.length; i++) fd.append('files', files[i]);
        fetch('/api/upload', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.paths && data.paths.length) {
                    var fileArr = Array.prototype.slice.call(files);
                    for (var j = 0; j < data.paths.length; j++) {
                        var file = fileArr[j];
                        var path = data.paths[j];
                        var isImg = file && (file.type || '').indexOf('image/') === 0;
                        attachmentList.push({
                            path: path,
                            name: file ? file.name : path.replace(/^.*\//, ''),
                            type: file ? file.type : '',
                            previewUrl: file && isImg ? URL.createObjectURL(file) : null
                        });
                    }
                    renderAttachmentChips();
                }
                if (data.error) showError(formatErrorForLock(data.error));
            })
            .catch(function() { showError('ä¸Šä¼ å¤±è´¥'); });
    }

    btnUploadEl.addEventListener('click', function() { fileInputEl.click(); });
    fileInputEl.addEventListener('change', function() {
        var files = this.files;
        if (files && files.length) uploadFiles(Array.prototype.slice.call(files));
        this.value = '';
    });

    inputWrapEl.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        inputWrapEl.classList.add('drag-over');
    });
    inputWrapEl.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!inputWrapEl.contains(e.relatedTarget)) inputWrapEl.classList.remove('drag-over');
    });
    inputWrapEl.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        inputWrapEl.classList.remove('drag-over');
        var files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length) uploadFiles(Array.prototype.slice.call(files));
    });

    var LOCK_SWITCH_MSG = 'å½“å‰çš„ä¾›åº”å•†æ— æ•ˆï¼Œå·²åˆ‡æ¢è‡³å¯¹è¯åŸä¾›åº”å•†æ¨¡å‹';
    function formatErrorForLock(msg) {
        if (!msg) return msg;
        var isBindingError = (msg && msg.indexOf('å›ºå®šæ¨¡å‹ç»´æŠ¤') !== -1);
        if (conversationLockedModel && isBindingError) return LOCK_SWITCH_MSG;
        if (conversationLockedModel) return LOCK_SWITCH_MSG + '\n' + msg;
        return msg;
    }
    function showError(msg) {
        errorEl.textContent = msg || '';
        errorEl.style.display = msg ? 'block' : 'none';
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function formatStepTitle(toolName, argumentsPreview) {
        var name = (toolName || '').trim() || 'tool';
        var cssClass = 'step-tool-pill step-tool-' + name.replace(/[^a-z0-9_]/gi, '_');
        var pill = '<span class="' + cssClass + '">' + escapeHtml(name) + '</span>';
        var arg = '';
        if (argumentsPreview && typeof argumentsPreview === 'string') {
            var s = argumentsPreview.trim().replace(/^\{|\}$/g, '').trim();
            var idx = s.indexOf('": "');
            if (idx !== -1) {
                idx += 4;
                var end = idx;
                while (end < s.length) {
                    if (s[end] === '\\' && end + 1 < s.length) { end += 2; continue; }
                    if (s[end] === '"') break;
                    end++;
                }
                arg = s.substring(idx, end).replace(/\\"/g, '"');
                if (arg.length > 80) arg = arg.substring(0, 77) + 'â€¦';
            }
        }
        var argHtml = arg ? '<span class="step-arg-pill">' + escapeHtml(arg) + '</span>' : '';
        return '<span class="step-call-label">è°ƒç”¨</span> ' + pill + (argHtml ? ' ' + argHtml : '');
    }

    function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true });
            return marked.parse(text || '');
        }
        return escapeHtml(text).replace(/\n/g, '<br>');
    }

    function fillModelOptions() {
        const curIdx = modelOptionEl.value === '' ? -1 : parseInt(modelOptionEl.value, 10);
        modelOptionEl.innerHTML = '';
        providers.forEach(function(p, i) {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = p.label;
            if (i === curIdx || (curIdx < 0 && i === 0)) opt.selected = true;
            modelOptionEl.appendChild(opt);
        });
        updateToolbarOptionsVisibility();
    }

    var deepThinkingEnabled = false;
    var utcpPluginEnabled = true;
    var utcpToolsEnabled = true;
    var webPreviewEnabled = true;
    var longTaskThresholdSeconds = 10;
    function updateToolbarOptionsVisibility() {
        const idx = parseInt(modelOptionEl.value, 10);
        const p = providers[idx];
        if (!p) {
            btnDeepThinkingEl.style.display = 'none';
            return;
        }
        btnDeepThinkingEl.style.display = p.support_deep_thinking ? 'inline-block' : 'none';
        if (!p.support_deep_thinking) {
            deepThinkingEnabled = false;
            btnDeepThinkingEl.classList.remove('active');
        }
    }

    function refreshModelsThenUpdateUI() {
        fetch('/api/models').then(function(r) { return r.json(); }).then(function(data) {
            if (data.providers && data.providers.length) providers = data.providers;
            else if (data.models && data.models.length) providers = data.models;
            utcpPluginEnabled = data.utcp_plugin_enabled !== false;
            utcpToolsEnabled = data.utcp_tools_enabled !== false;
            webPreviewEnabled = data.web_preview_enabled !== false;
            conversationLockModelEnabled = data.conversation_lock_model !== false;
            if (data.utcp_long_task_seconds != null) longTaskThresholdSeconds = Math.max(1, parseInt(data.utcp_long_task_seconds, 10) || 10);
            fillModelOptions();
        }).catch(function() {
            fillModelOptions();
        });
    }

    modelOptionEl.addEventListener('change', updateToolbarOptionsVisibility);

    btnDeepThinkingEl.addEventListener('click', function() {
        if (!providers[parseInt(modelOptionEl.value, 10)] || !providers[parseInt(modelOptionEl.value, 10)].support_deep_thinking) return;
        deepThinkingEnabled = !deepThinkingEnabled;
        btnDeepThinkingEl.classList.toggle('active', deepThinkingEnabled);
    });

    fillModelOptions();
    refreshModelsThenUpdateUI();

    function addMessage(role, content, options) {
        options = options || {};
        const div = document.createElement('div');
        div.className = 'msg ' + role;
        div.dataset.role = role;
        if (options.id) div.id = options.id;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (role === 'user') {
            bubble.textContent = content;
        } else if (options.forStreaming) {
            var stepsPanel = document.createElement('div');
            stepsPanel.className = 'steps-panel collapsed';
            var phaseEl = document.createElement('div');
            phaseEl.className = 'steps-panel-phase';
            phaseEl.setAttribute('aria-live', 'polite');
            var header = document.createElement('div');
            header.className = 'steps-panel-header';
            header.innerHTML = '<span class="steps-panel-summary">æœ¬è½®æ‰§è¡Œ 0 æ¬¡å‘½ä»¤</span><span class="steps-panel-total-time"></span><span class="steps-panel-arrow">â–¼</span>';
            header.addEventListener('click', function() { stepsPanel.classList.toggle('collapsed'); });
            var body = document.createElement('div');
            body.className = 'steps-panel-body';
            stepsPanel.appendChild(phaseEl);
            stepsPanel.appendChild(header);
            stepsPanel.appendChild(body);
            var contentWrap = document.createElement('div');
            contentWrap.className = 'stream-content';
            bubble.appendChild(stepsPanel);
            bubble.appendChild(contentWrap);
        } else if (role === 'assistant' && options.tool_steps && options.tool_steps.length > 0) {
            var planContent = '';
            var mainContent = content;
            if (content.indexOf('ã€å½“å‰æƒ…å†µä¸è®¡åˆ’ã€‘') === 0 && content.indexOf('\n\n---\n\n') !== -1) {
                var parts = content.split('\n\n---\n\n');
                var first = parts[0].replace(/^ã€å½“å‰æƒ…å†µä¸è®¡åˆ’ã€‘\s*\n?\n?/, '');
                planContent = first;
                mainContent = parts.length > 1 ? parts.slice(1).join('\n\n---\n\n') : '';
            }
            if (planContent) {
                var planPanel = document.createElement('div');
                planPanel.className = 'plan-panel';
                planPanel.innerHTML = '<div class="plan-panel-title">å½“å‰æƒ…å†µä¸è®¡åˆ’</div><div class="plan-panel-body">' + renderMarkdown(planContent) + '</div>';
                bubble.appendChild(planPanel);
            }
            var stepsPanel = document.createElement('div');
            stepsPanel.className = 'steps-panel collapsed';
            var n = options.tool_steps.length;
            var header = document.createElement('div');
            header.className = 'steps-panel-header';
            header.innerHTML = '<span class="steps-panel-summary">æœ¬è½®æ‰§è¡Œ ' + n + ' æ¬¡å‘½ä»¤</span><span class="steps-panel-total-time"></span><span class="steps-panel-arrow">â–¼</span>';
            header.addEventListener('click', function() { stepsPanel.classList.toggle('collapsed'); });
            var body = document.createElement('div');
            body.className = 'steps-panel-body';
            options.tool_steps.forEach(function(s) {
                var step = document.createElement('div');
                step.className = 'step-item collapsed done' + (s.success === false ? ' failed' : '');
                if (s.elapsed_seconds != null && s.elapsed_seconds >= longTaskThresholdSeconds) step.classList.add('step-item-long');
                var iconChar = s.success === false ? 'âœ—' : 'âœ“';
                var nameLine = formatStepTitle(s.name, s.arguments_preview);
                var resultText = (s.result_full || s.result_summary || '');
                var elapsedHtml = (s.elapsed_seconds != null) ? '<span class="step-elapsed">è€—æ—¶ ' + Number(s.elapsed_seconds) + 's</span>' : '';
                step.innerHTML = '<div class="step-item-header"><span class="step-icon">' + iconChar + '</span><div class="step-body"><div class="step-name">' + nameLine + '</div>' + elapsedHtml + '</div></div><div class="step-item-body"><div class="step-item-body-title">' + nameLine + '</div><div class="step-result">' + escapeHtml(resultText) + '</div></div>';
                step.querySelector('.step-item-header').addEventListener('click', function() { step.classList.toggle('collapsed'); });
                body.appendChild(step);
            });
            stepsPanel.appendChild(header);
            stepsPanel.appendChild(body);
            bubble.appendChild(stepsPanel);
            var contentWrap = document.createElement('div');
            contentWrap.className = 'stream-content';
            contentWrap.innerHTML = renderMarkdown(mainContent);
            bubble.appendChild(contentWrap);
        } else {
            bubble.innerHTML = renderMarkdown(content);
        }
        if (role === 'assistant' && currentConversationId && options.turnIndex != null && options.turnIndex >= 0) {
            var delTurnWrap = document.createElement('div');
            delTurnWrap.className = 'msg-del-turn-wrap';
            var delTurnBtn = document.createElement('button');
            delTurnBtn.type = 'button';
            delTurnBtn.className = 'msg-del-turn';
            delTurnBtn.textContent = 'åˆ é™¤è¯¥è½®';
            delTurnBtn.dataset.turnIndex = String(options.turnIndex);
            delTurnBtn.addEventListener('click', function() {
                var turnIndex = parseInt(this.dataset.turnIndex, 10);
                showConfirmDeleteTurn(currentConversationId, turnIndex);
            });
            delTurnWrap.appendChild(delTurnBtn);
            bubble.appendChild(delTurnWrap);
        }
        const roleLabel = role === 'user' ? 'ä½ ' : (options.model_label || 'åŠ©æ‰‹');
        div.innerHTML = '';
        var roleEl = document.createElement('div');
        roleEl.className = 'role';
        roleEl.textContent = roleLabel;
        div.appendChild(roleEl);
        div.appendChild(bubble);
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return bubble;
    }

    function renderConversationList() {
        fetch('/api/conversations')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                conversationListEl.innerHTML = '';
                (data.conversations || []).forEach(function(c) {
                    const wrap = document.createElement('div');
                    wrap.className = 'sidebar-item' + (c.id === currentConversationId ? ' active' : '');
                    wrap.dataset.id = c.id;
                    const title = document.createElement('span');
                    title.className = 'sidebar-item-title';
                    title.textContent = c.title || 'æ–°å¯¹è¯';
                    const btnDel = document.createElement('button');
                    btnDel.type = 'button';
                    btnDel.className = 'btn-del';
                    btnDel.textContent = 'åˆ é™¤';
                    btnDel.setAttribute('aria-label', 'åˆ é™¤');
                    wrap.appendChild(title);
                    wrap.appendChild(btnDel);
                    wrap.addEventListener('click', function(ev) {
                        if (ev.target === btnDel) return;
                        loadConversation(c.id);
                    });
                    btnDel.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        showConfirmDelete(c.id);
                    });
                    conversationListEl.appendChild(wrap);
                });
            })
            .catch(function() {});
    }

    function loadConversation(cid) {
        currentConversationId = cid;
        messages = [];
        messagesEl.innerHTML = '';
        fetch('/api/conversations/' + encodeURIComponent(cid))
            .then(function(r) { return r.json(); })
            .then(function(conv) {
                if (!conv.messages) return;
                conversationLockedModel = null;
                if (conversationLockModelEnabled && conv.provider_id != null && conv.model != null && conv.messages.length > 0) {
                    conversationLockedModel = { providerId: conv.provider_id, model: conv.model };
                    var idx = -1;
                    for (var i = 0; i < providers.length; i++) {
                        if (providers[i].provider_id === conv.provider_id && providers[i].model === conv.model) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx >= 0) modelOptionEl.value = String(idx);
                    modelOptionEl.disabled = true;
                } else {
                    modelOptionEl.disabled = false;
                }
                conv.messages.forEach(function(m, i) {
                    var opts = { model_label: m.model_label, tool_steps: m.tool_steps };
                    if (m.role === 'assistant') opts.turnIndex = Math.floor(i / 2);
                    addMessage(m.role, m.content || '', opts);
                    messages.push({ role: m.role, content: m.content || '', model_label: m.model_label, tool_steps: m.tool_steps });
                });
                renderConversationList();
                if (typeof saveChatState === 'function') saveChatState();
            })
            .catch(function() { renderConversationList(); });
    }

    function startNewChat() {
        currentConversationId = null;
        messages = [];
        messagesEl.innerHTML = '';
        conversationLockedModel = null;
        modelOptionEl.disabled = false;
        renderConversationList();
        if (typeof saveChatState === 'function') saveChatState();
    }

    var pendingDeleteId = null;
    var pendingDeleteTurn = null;
    var confirmOverlay = document.getElementById('confirmOverlay');
    var confirmCard = document.getElementById('confirmCard');
    var confirmTitleEl = document.getElementById('confirmTitle');
    var confirmOk = document.getElementById('confirmOk');
    var confirmCancel = document.getElementById('confirmCancel');

    function showConfirmDelete(cid) {
        pendingDeleteId = cid;
        pendingDeleteTurn = null;
        confirmTitleEl.textContent = 'ç¡®å®šåˆ é™¤è¯¥å¯¹è¯ï¼Ÿ';
        confirmOverlay.classList.add('show');
        confirmOverlay.setAttribute('aria-hidden', 'false');
    }
    function showConfirmDeleteTurn(cid, turnIndex) {
        pendingDeleteTurn = { cid: cid, turnIndex: turnIndex };
        pendingDeleteId = null;
        confirmTitleEl.textContent = 'ç¡®å®šåˆ é™¤è¿™ä¸€è½®å¯¹è¯ï¼Ÿ';
        confirmOverlay.classList.add('show');
        confirmOverlay.setAttribute('aria-hidden', 'false');
    }
    function hideConfirm() {
        pendingDeleteId = null;
        pendingDeleteTurn = null;
        confirmOverlay.classList.remove('show');
        confirmOverlay.setAttribute('aria-hidden', 'true');
    }
    function doConfirmDelete() {
        if (pendingDeleteTurn) {
            var cid = pendingDeleteTurn.cid;
            var turnIndex = pendingDeleteTurn.turnIndex;
            hideConfirm();
            fetch('/api/conversations/' + encodeURIComponent(cid) + '/messages', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remove_turn_index: turnIndex })
            })
                .then(function(r) { return r.json(); })
                .then(function() {
                    loadConversation(cid);
                    renderConversationList();
                })
                .catch(function() {});
            return;
        }
        if (!pendingDeleteId) return;
        var cid = pendingDeleteId;
        hideConfirm();
        fetch('/api/conversations/' + encodeURIComponent(cid), { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function() {
                if (currentConversationId === cid) startNewChat();
                else currentConversationId = null;
                renderConversationList();
            });
    }
    confirmOk.addEventListener('click', doConfirmDelete);
    confirmCancel.addEventListener('click', hideConfirm);
    confirmOverlay.addEventListener('click', function(ev) {
        if (ev.target === confirmOverlay) hideConfirm();
    });
    confirmCard.addEventListener('click', function(ev) { ev.stopPropagation(); });
    document.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape' && confirmOverlay.classList.contains('show')) hideConfirm();
    });

    newChatBtn.addEventListener('click', startNewChat);
    renderConversationList();

    function getCurrentProviderAndModel() {
        if (conversationLockedModel) {
            var p = null;
            for (var i = 0; i < providers.length; i++) {
                if (providers[i].provider_id === conversationLockedModel.providerId && providers[i].model === conversationLockedModel.model) {
                    p = providers[i];
                    break;
                }
            }
            if (!p) return { providerId: conversationLockedModel.providerId, model: conversationLockedModel.model, useUtcpTools: false, useDeepThinking: false };
            return {
                providerId: conversationLockedModel.providerId,
                model: conversationLockedModel.model,
                useUtcpTools: utcpPluginEnabled && p.support_function_calling && utcpToolsEnabled,
                useDeepThinking: p.support_deep_thinking && deepThinkingEnabled
            };
        }
        var idx = parseInt(modelOptionEl.value, 10);
        var p = providers[idx];
        if (!p) return { providerId: '', model: '', useUtcpTools: false, useDeepThinking: false };
        return {
            providerId: p.provider_id,
            model: p.model,
            useUtcpTools: utcpPluginEnabled && p.support_function_calling && utcpToolsEnabled,
            useDeepThinking: p.support_deep_thinking && deepThinkingEnabled
        };
    }

    function sendMessage() {
        const text = (inputEl.value || '').trim();
        if (!text && attachmentList.length === 0) return;
        var sel = getCurrentProviderAndModel();
        var providerId = sel.providerId;
        var model = sel.model;
        if (!providerId || !model) {
            showError('è¯·å…ˆé€‰æ‹©æ¨¡å‹');
            return;
        }
        var userContent = text || 'ï¼ˆä»…ä¸Šä¼ äº†æ–‡ä»¶ï¼‰';
        messages.push({ role: 'user', content: userContent });
        addMessage('user', userContent + (attachmentList.length ? ' [å·²é™„ ' + attachmentList.length + ' ä¸ªæ–‡ä»¶]' : ''));
        inputEl.value = '';
        resizeInput();
        if (typeof saveChatState === 'function') saveChatState();
        var pathsToSend = attachmentList.map(function(x) { return x.path; });
        attachmentList.forEach(function(it) { if (it.previewUrl) URL.revokeObjectURL(it.previewUrl); });
        attachmentList = [];
        renderAttachmentChips();
        sendBtn.disabled = true;
        showError('');
        var navStatusEl = document.getElementById('navChatStatus');
        var navHintEl = document.getElementById('navChatHint');
        if (navStatusEl) { navStatusEl.style.display = 'inline-block'; navStatusEl.textContent = 'å¯¹è¯è¿›è¡Œä¸­ï¼ˆç‚¹å‡»å¯ä¸­æ­¢ï¼‰'; }
        if (navHintEl) navHintEl.style.display = 'inline';
        // #region agent log
        fetch('http://localhost:7657/ingest/9622098c-f80f-4a8e-8441-85f50b6e1187',{method:'POST',headers:{'Content-Type':'application/json','X-Debug-Session-Id':'f9235e'},body:JSON.stringify({sessionId:'f9235e',location:'chat.html:status-shown',message:'nav status shown',data:{},timestamp:Date.now(),hypothesisId:'H1'})}).catch(function(){});
        // #endregion

        var currentLabel = (providers[parseInt(modelOptionEl.value, 10)] || {}).label || 'åŠ©æ‰‹';
        var useUtcpStream = sel.useUtcpTools;
        var assistantBubble = addMessage('assistant', '', { id: 'streaming-msg', model_label: currentLabel, forStreaming: useUtcpStream });
        var streamContent = '';
        var streamPlanContent = '';
        var streamToolSteps = [];
        var stepsPanel = useUtcpStream ? assistantBubble.querySelector('.steps-panel') : null;
        var stepsPanelBody = useUtcpStream ? (assistantBubble.querySelector('.steps-panel-body')) : null;
        var contentWrap = useUtcpStream ? assistantBubble.querySelector('.stream-content') : null;
        var planPanel = null;
        var webPreviewPanel = null;
        var streamAbortController = new AbortController();
        var streamStartTime = useUtcpStream ? Date.now() : 0;
        if (window.trialStreamAbort) window.trialStreamAbort = null;
        window.trialStreamAbort = function() { try { streamAbortController.abort(); } catch (e) {} };

        var currentPhase = '';
        var currentStepTimerStart = null;
        var phaseTimerInterval = null;
        function setPhase(phase) {
            currentPhase = phase;
            var phaseEl = stepsPanel ? stepsPanel.querySelector('.steps-panel-phase') : null;
            if (phaseEl) {
                var label = phase === 'explore' ? 'æ¢ç´¢é˜¶æ®µ' : (phase === 'plan' ? 'è®¡åˆ’å·²ç”Ÿæˆ' : (phase === 'execute' ? 'æ‰§è¡Œé˜¶æ®µ' : ''));
                phaseEl.textContent = '';
                phaseEl.appendChild(document.createTextNode(label));
                if (phase === 'execute') {
                    var t = document.createElement('span');
                    t.className = 'steps-panel-phase-timer';
                    phaseEl.appendChild(t);
                } else {
                    currentStepTimerStart = null;
                    if (phaseTimerInterval) clearInterval(phaseTimerInterval);
                    phaseTimerInterval = null;
                }
                phaseEl.classList.toggle('show', !!label);
            }
        }
        function updatePhaseTimer() {
            var phaseEl = stepsPanel ? stepsPanel.querySelector('.steps-panel-phase') : null;
            var timerSpan = phaseEl ? phaseEl.querySelector('.steps-panel-phase-timer') : null;
            if (!timerSpan) return;
            if (currentStepTimerStart != null && stepsPanelBody && stepsPanelBody.querySelector('.step-item.running')) {
                var sec = Math.floor((Date.now() - currentStepTimerStart) / 1000);
                timerSpan.textContent = 'å½“å‰æ­¥éª¤å·²æ‰§è¡Œ ' + sec + 's';
            } else {
                timerSpan.textContent = '';
            }
        }
        function updateStepsSummary() {
            if (!stepsPanel || !stepsPanelBody) return;
            var items = stepsPanelBody.querySelectorAll('.step-item');
            var n = items.length;
            var running = stepsPanelBody.querySelector('.step-item.running');
            var summaryEl = stepsPanel.querySelector('.steps-panel-summary');
            if (!summaryEl) return;
            if (n === 0) { summaryEl.textContent = 'æœ¬è½®æ‰§è¡Œ 0 æ¬¡å‘½ä»¤'; return; }
            var idx = running ? (running.dataset.stepIndex || '') : '';
            var total = running ? (running.dataset.stepTotal || '') : '';
            var progress = (idx && total) ? ('ï¼ˆå½“å‰ç¬¬ ' + idx + '/' + total + ' æ­¥ï¼‰') : '';
            var done = stepsPanelBody.querySelectorAll('.step-item.done').length;
            var failed = stepsPanelBody.querySelectorAll('.step-item.failed').length;
            var suffix = '';
            if (done === n && n > 0) suffix = failed ? ' Â· å…± ' + n + ' æ­¥ï¼Œ' + (n - failed) + ' æˆåŠŸï¼Œ' + failed + ' å¤±è´¥' : ' Â· å…± ' + n + ' æ­¥';
            var last = stepsPanelBody.querySelector('.step-item:last-child .step-name');
            var lastName = last ? (last.textContent || '').replace(/^è°ƒç”¨\s*/, '').trim().substring(0, 28) : '';
            summaryEl.textContent = 'æœ¬è½®æ‰§è¡Œ ' + n + ' æ¬¡å‘½ä»¤' + progress + (lastName ? ' Â· ' + lastName : '') + suffix;
        }

        fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: streamAbortController.signal,
            body: JSON.stringify({
                provider_id: providerId,
                model: model,
                messages: messages,
                conversation_id: currentConversationId,
                use_utcp_tools: sel.useUtcpTools,
                use_deep_thinking: sel.useDeepThinking,
                attachment_paths: pathsToSend
            })
        })
        .then(function(response) {
            if (!response.ok) return response.json().then(function(d) { throw new Error(d.error || 'è¯·æ±‚å¤±è´¥'); });
            return response.body.getReader();
        })
        .then(function(reader) {
            var decoder = new TextDecoder();
            var buffer = '';
            function read() {
                return reader.read().then(function(result) {
                    if (result.done) {
                        // #region agent log
                        fetch('http://localhost:7657/ingest/9622098c-f80f-4a8e-8441-85f50b6e1187',{method:'POST',headers:{'Content-Type':'application/json','X-Debug-Session-Id':'f9235e'},body:JSON.stringify({sessionId:'f9235e',location:'chat.html:read-done',message:'stream result.done true',data:{},timestamp:Date.now(),hypothesisId:'H3'})}).catch(function(){});
                        // #endregion
                        return;
                    }
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    lines.forEach(function(line) {
                        if (line.startsWith('data: ')) {
                            try {
                                var data = JSON.parse(line.slice(6));
                                if (data.type === 'phase') {
                                    setPhase(data.phase || '');
                                } else if (data.type === 'tool_call' && stepsPanelBody) {
                                    streamToolSteps.push({ name: data.name || '', arguments_preview: data.arguments_preview || '', result_summary: '', result_full: '', step_index: data.step_index, step_total: data.step_total });
                                    var step = document.createElement('div');
                                    step.className = 'step-item collapsed running';
                                    step.dataset.toolCallId = data.tool_call_id || '';
                                    if (data.step_index != null) step.dataset.stepIndex = String(data.step_index);
                                    if (data.step_total != null) step.dataset.stepTotal = String(data.step_total);
                                    var nameLine = formatStepTitle(data.name, data.arguments_preview);
                                    step.innerHTML = '<div class="step-item-header"><span class="step-icon">â³</span><div class="step-body"><div class="step-name">' + nameLine + '</div></div></div><div class="step-item-body"><div class="step-item-body-title">' + nameLine + '</div><div class="step-result"></div></div>';
                                    step.querySelector('.step-item-header').addEventListener('click', function() { step.classList.toggle('collapsed'); });
                                    stepsPanelBody.appendChild(step);
                                    updateStepsSummary();
                                    onTaskInfoUpdate();
                                    currentStepTimerStart = Date.now();
                                    if (phaseTimerInterval) clearInterval(phaseTimerInterval);
                                    phaseTimerInterval = setInterval(updatePhaseTimer, 1000);
                                    updatePhaseTimer();
                                } else if (data.type === 'web_view' && useUtcpStream && webPreviewEnabled) {
                                    var url = (data.url || '').trim();
                                    if (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) {
                                        if (!webPreviewPanel) {
                                            webPreviewPanel = document.createElement('div');
                                            webPreviewPanel.className = 'web-preview-panel';
                                            var headerHtml = '<span>Web é¡µé¢é¢„è§ˆ</span><a class="web-preview-open-tab" href="#" target="_blank" rel="noopener">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</a>';
                                            webPreviewPanel.innerHTML = '<div class="web-preview-header">' + headerHtml + '</div><div class="web-preview-iframe-wrap"><iframe class="web-preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" title="é¢„è§ˆ"></iframe></div>';
                                            var bubble = stepsPanel && stepsPanel.parentNode;
                                            if (bubble && contentWrap) bubble.insertBefore(webPreviewPanel, contentWrap);
                                            var hdr = webPreviewPanel.querySelector('.web-preview-header');
                                            if (hdr) hdr.addEventListener('click', function(e) { if (!e.target.closest('.web-preview-open-tab')) webPreviewPanel.classList.toggle('collapsed'); });
                                            var openTabEl = webPreviewPanel.querySelector('.web-preview-open-tab');
                                            if (openTabEl) openTabEl.addEventListener('click', function(e) { e.stopPropagation(); });
                                        }
                                        if (webPreviewPanel) {
                                            var ifr = webPreviewPanel.querySelector('.web-preview-iframe');
                                            if (ifr) {
                                                var iframeSrc = url;
                                                try {
                                                    var a = document.createElement('a');
                                                    a.href = url;
                                                    var host = (a.hostname || '').toLowerCase();
                                                    if (host === 'localhost' || host === '127.0.0.1' || host === '') iframeSrc = '/api/web-preview-proxy?url=' + encodeURIComponent(url);
                                                } catch (e) {}
                                                ifr.src = iframeSrc;
                                            }
                                            var openTab = webPreviewPanel.querySelector('.web-preview-open-tab');
                                            if (openTab) openTab.href = url;
                                        }
                                        messagesEl.scrollTop = messagesEl.scrollHeight;
                                    }
                                } else if (data.type === 'plan') {
                                    streamPlanContent = data.content || '';
                                    if (stepsPanel && !planPanel) {
                                        planPanel = document.createElement('div');
                                        planPanel.className = 'plan-panel';
                                        planPanel.innerHTML = '<div class="plan-panel-title">å½“å‰æƒ…å†µä¸è®¡åˆ’</div><div class="plan-panel-body"></div>';
                                        stepsPanel.parentNode.insertBefore(planPanel, stepsPanel);
                                    }
                                    if (planPanel) planPanel.querySelector('.plan-panel-body').innerHTML = renderMarkdown(streamPlanContent);
                                    messagesEl.scrollTop = messagesEl.scrollHeight;
                                    onTaskInfoUpdate();
                                } else if (data.type === 'tool_result' && stepsPanelBody) {
                                    var tid = data.tool_call_id || '';
                                    var fullText = (data.result_full || data.result_summary || '');
                                    var summary = (data.result_summary || data.result_full || '').substring(0, 2000);
                                    var full = (data.result_full || data.result_summary || '').substring(0, 8000);
                                    for (var i = streamToolSteps.length - 1; i >= 0; i--) {
                                        if (!streamToolSteps[i].result_full) {
                                            streamToolSteps[i].result_summary = summary;
                                            streamToolSteps[i].result_full = full;
                                            if (data.success === false) streamToolSteps[i].success = false;
                                            if (data.elapsed_seconds != null) streamToolSteps[i].elapsed_seconds = data.elapsed_seconds;
                                            break;
                                        }
                                    }
                                    var stepEl = null;
                                    stepsPanelBody.querySelectorAll('.step-item').forEach(function(s) { if (s.dataset.toolCallId === tid) stepEl = s; });
                                    if (stepEl) {
                                        stepEl.classList.remove('running');
                                        stepEl.classList.add('done');
                                        if (data.success === false) stepEl.classList.add('failed');
                                        if (data.elapsed_seconds != null && data.elapsed_seconds >= longTaskThresholdSeconds) stepEl.classList.add('step-item-long');
                                        var icon = stepEl.querySelector('.step-icon');
                                        if (icon) icon.textContent = data.success === false ? 'âœ—' : 'âœ“';
                                        var res = stepEl.querySelector('.step-result');
                                        if (res) res.textContent = fullText;
                                        if (data.elapsed_seconds != null) {
                                            var nameWrap = stepEl.querySelector('.step-body');
                                            if (nameWrap) {
                                                var elapsedSpan = nameWrap.querySelector('.step-elapsed');
                                                if (!elapsedSpan) { elapsedSpan = document.createElement('span'); elapsedSpan.className = 'step-elapsed'; nameWrap.appendChild(elapsedSpan); }
                                                elapsedSpan.textContent = 'è€—æ—¶ ' + data.elapsed_seconds + 's';
                                            }
                                        }
                                        if (phaseTimerInterval) clearInterval(phaseTimerInterval);
                                        phaseTimerInterval = null;
                                        currentStepTimerStart = null;
                                        updatePhaseTimer();
                                    }
                                    updateStepsSummary();
                                    onTaskInfoUpdate();
                                } else if (data.content !== undefined) {
                                    streamContent += (data.content || '');
                                    if (contentWrap) contentWrap.innerHTML = renderMarkdown(streamContent);
                                    else assistantBubble.innerHTML = renderMarkdown(streamContent);
                                    messagesEl.scrollTop = messagesEl.scrollHeight;
                                }
                                if (data.conversation_id) { currentConversationId = data.conversation_id; renderConversationList(); if (typeof saveChatState === 'function') saveChatState(); }
                                if (data.error) showError(formatErrorForLock(data.error));
                            } catch (e) {}
                        }
                    });
                    return read();
                });
            }
            return read();
        })
        .then(function() {
            // #region agent log
            fetch('http://localhost:7657/ingest/9622098c-f80f-4a8e-8441-85f50b6e1187',{method:'POST',headers:{'Content-Type':'application/json','X-Debug-Session-Id':'f9235e'},body:JSON.stringify({sessionId:'f9235e',location:'chat.html:then-success',message:'stream then success',data:{},timestamp:Date.now(),hypothesisId:'H5'})}).catch(function(){});
            // #endregion
            if (stepsPanel && stepsPanelBody) {
                if (stepsPanelBody.querySelectorAll('.step-item').length === 0) stepsPanel.style.display = 'none';
                else {
                    updateStepsSummary();
                    if (streamStartTime > 0) {
                        var totalEl = stepsPanel.querySelector('.steps-panel-total-time');
                        if (totalEl) {
                            var ms = Date.now() - streamStartTime;
                            var s = Math.floor(ms / 1000); var m = Math.floor(s / 60); var h = Math.floor(m / 60);
                            s = s % 60; m = m % 60;
                            var text = 'æ€»è€—æ—¶ ';
                            if (h > 0) text += h + 'å°æ—¶';
                            if (m > 0 || h > 0) text += m + 'åˆ†';
                            text += s + 'ç§’';
                            totalEl.textContent = text;
                        }
                    }
                }
            }
            var finalContent = streamPlanContent ? ('ã€å½“å‰æƒ…å†µä¸è®¡åˆ’ã€‘\n\n' + streamPlanContent + '\n\n---\n\n' + streamContent) : streamContent;
            messages.push({ role: 'assistant', content: finalContent, model_label: currentLabel, tool_steps: streamToolSteps.length ? streamToolSteps : undefined });
            var el = document.getElementById('streaming-msg');
            if (el) el.id = '';
            renderConversationList();
            if (typeof saveChatState === 'function') saveChatState();
        })
        .catch(function(e) {
            // #region agent log
            fetch('http://localhost:7657/ingest/9622098c-f80f-4a8e-8441-85f50b6e1187',{method:'POST',headers:{'Content-Type':'application/json','X-Debug-Session-Id':'f9235e'},body:JSON.stringify({sessionId:'f9235e',location:'chat.html:catch',message:'stream catch',data:{name:(e&&e.name)||'',msg:(e&&e.message)||''},timestamp:Date.now(),hypothesisId:'H4'})}).catch(function(){});
            // #endregion
            if (e.name !== 'AbortError') {
                var errMsg = e.message || 'è¯·æ±‚å¤±è´¥';
                if (conversationLockedModel && errMsg.indexOf('å›ºå®šæ¨¡å‹ç»´æŠ¤') !== -1) {
                    var idx = -1;
                    for (var i = 0; i < providers.length; i++) {
                        if (providers[i].provider_id === conversationLockedModel.providerId && providers[i].model === conversationLockedModel.model) { idx = i; break; }
                    }
                    if (idx >= 0) modelOptionEl.value = String(idx);
                }
                showError(formatErrorForLock(errMsg));
            }
            var el = document.getElementById('streaming-msg');
            if (el) el.remove();
            if (e.name !== 'AbortError') messages.pop();
        })
        .finally(function() {
            // #region agent log
            var _nav = document.getElementById('navChatStatus');
            fetch('http://localhost:7657/ingest/9622098c-f80f-4a8e-8441-85f50b6e1187',{method:'POST',headers:{'Content-Type':'application/json','X-Debug-Session-Id':'f9235e'},body:JSON.stringify({sessionId:'f9235e',location:'chat.html:finally',message:'stream finally',data:{navStatusElExists:!!_nav},timestamp:Date.now(),hypothesisId:'H1'})}).catch(function(){});
            // #endregion
            if (phaseTimerInterval) clearInterval(phaseTimerInterval);
            phaseTimerInterval = null;
            currentStepTimerStart = null;
            sendBtn.disabled = false;
            var navStatusEl = document.getElementById('navChatStatus');
            var navHintEl = document.getElementById('navChatHint');
            if (navStatusEl) { navStatusEl.style.display = 'none'; navStatusEl.textContent = 'å¯¹è¯è¿›è¡Œä¸­'; }
            if (navHintEl) navHintEl.style.display = 'none';
            window.trialStreamAbort = null;
        });
    }

    sendBtn.addEventListener('click', sendMessage);
    function resizeInput() {
        var ta = inputEl;
        ta.style.height = 'auto';
        ta.style.height = Math.min(200, Math.max(44, ta.scrollHeight)) + 'px';
    }
    inputEl.addEventListener('input', resizeInput);
    inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    resizeInput();

    var navStatusEl = document.getElementById('navChatStatus');
    var CONV_ID_STORAGE_KEY = 'trial_chat_conversation_id';
    var DRAFT_STORAGE_KEY = 'trial_chat_draft';

    function saveChatState() {
        try {
            if (currentConversationId) {
                sessionStorage.setItem(CONV_ID_STORAGE_KEY, currentConversationId);
            } else {
                sessionStorage.removeItem(CONV_ID_STORAGE_KEY);
            }
            var draft = (inputEl.value || '').trim();
            if (draft) sessionStorage.setItem(DRAFT_STORAGE_KEY, draft);
            else sessionStorage.removeItem(DRAFT_STORAGE_KEY);
        } catch (err) {}
    }

    function applyServerConversation(conv) {
        if (!conv) return;
        messages = [];
        messagesEl.innerHTML = '';
        (conv.messages || []).forEach(function(m) {
            addMessage(m.role, m.content || '', { model_label: m.model_label, tool_steps: m.tool_steps });
            messages.push({ role: m.role, content: m.content || '', model_label: m.model_label, tool_steps: m.tool_steps });
        });
        renderConversationList();
        saveChatState();
    }

    function restoreChatState() {
        try {
            var savedId = sessionStorage.getItem(CONV_ID_STORAGE_KEY);
            renderConversationList();
            if (savedId) {
                currentConversationId = savedId;
                messagesEl.innerHTML = '<div class="chat-empty-hint">æ­£åœ¨æ¢å¤å¯¹è¯â€¦</div>';
                fetch('/api/conversations/' + encodeURIComponent(savedId))
                    .then(function(r) { return r.json(); })
                    .then(function(conv) {
                        applyServerConversation(conv);
                    })
                    .catch(function() {
                        currentConversationId = null;
                        messages = [];
                        messagesEl.innerHTML = '';
                        renderConversationList();
                    });
            } else {
                messagesEl.innerHTML = '<div class="chat-empty-hint">æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½â€¦</div>';
                fetch('/api/conversations')
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var list = data.conversations || [];
                        if (list.length > 0) {
                            currentConversationId = list[0].id;
                            return fetch('/api/conversations/' + encodeURIComponent(list[0].id)).then(function(res) { return res.json(); });
                        }
                        return null;
                    })
                    .then(function(conv) {
                        if (conv) {
                            applyServerConversation(conv);
                        } else {
                            messages = [];
                            messagesEl.innerHTML = '';
                            renderConversationList();
                        }
                    })
                    .catch(function() { renderConversationList(); });
            }
            var draft = sessionStorage.getItem(DRAFT_STORAGE_KEY);
            if (draft && inputEl) { inputEl.value = draft; resizeInput(); }
        } catch (err) { renderConversationList(); }
    }

    window.addEventListener('beforeunload', saveChatState);
    window.addEventListener('pagehide', saveChatState);
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') saveChatState();
        else if (document.visibilityState === 'visible' && currentConversationId) {
            fetch('/api/conversations/' + encodeURIComponent(currentConversationId))
                .then(function(r) { return r.json(); })
                .then(function(conv) { if (conv) applyServerConversation(conv); })
                .catch(function() {});
        }
    });
    window.addEventListener('pageshow', function(ev) {
        if (ev.persisted) restoreChatState();
    });
    restoreChatState();

    var navChatStatusEl = document.getElementById('navChatStatus');
    if (navChatStatusEl) {
        navChatStatusEl.addEventListener('click', function() {
            if (typeof window.trialStreamAbort === 'function') window.trialStreamAbort();
        });
    }
})();
</script>
{% endblock %}
