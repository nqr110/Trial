{% extends "settings_base.html" %}
{% block title %}全局配置 - Trial{% endblock %}
{% block extra_css %}
{{ super() }}
.global-wrap { max-width: 100%; margin: 0; padding: 0; }
.global-wrap .global-head { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
.global-wrap h1 { font-size: 1.25rem; margin: 0; }
.global-wrap .global-layout-select { font-size: 0.875rem; color: var(--muted); padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); }
.global-sections { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.global-sections.cols-1 { grid-template-columns: 1fr; }
.global-sections.cols-3 { grid-template-columns: repeat(3, 1fr); }
.global-section { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; }
.global-section h2 { font-size: 1rem; margin: 0 0 0.75rem 0; color: var(--text); }
.global-section .desc { color: var(--muted); font-size: 0.875rem; margin-bottom: 0.75rem; }
.btn-check { padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
.btn-check:hover { background: var(--accent-hover); }
.btn-check:disabled { opacity: 0.6; cursor: not-allowed; }
.check-result { margin-top: 0.75rem; font-size: 0.875rem; }
.check-result .item { padding: 0.35rem 0; border-bottom: 1px solid var(--border); }
.check-result .item:last-child { border-bottom: none; }
.check-result .ok { color: #059669; }
.check-result .err { color: #dc2626; }
.toggle-row label { font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
.toggle-row input[type="checkbox"] { width: 1.1rem; height: 1.1rem; cursor: pointer; }
.status-msg { font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem; }
.system-prompt-textarea { width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; font-family: inherit; resize: vertical; min-height: 120px; box-sizing: border-box; }
.system-prompt-textarea:focus { outline: none; border-color: var(--accent); }
{% endblock %}
{% block settings_content %}
<div class="global-wrap">
    <div class="global-head">
        <h1>全局配置</h1>
        <label>排布
            <select id="globalLayoutCols" class="global-layout-select" aria-label="子配置项排布列数">
                <option value="1">一列</option>
                <option value="2" selected>两列</option>
                <option value="3">三列</option>
            </select>
        </label>
    </div>
    <div class="global-sections" id="globalSections">
    <section class="global-section">
        <h2>API 配置检测</h2>
        <p class="desc">检测当前已配置的各服务商 API 是否可用。</p>
        <button type="button" class="btn-check" id="btnCheck">检测 API</button>
        <div class="check-result" id="checkResult" style="display: none;"></div>
    </section>
    <section class="global-section">
        <h2>是否启用 UTCP 插件</h2>
        <p class="desc">关闭后，对话页将不展示与 UTCP 相关的选项。</p>
        <label class="toggle-row"><input type="checkbox" id="utcpEnabled" {% if utcp_plugin_enabled %}checked{% endif %}> 启用 UTCP 插件</label>
        <div class="status-msg" id="utcpStatus"></div>
    </section>
    <section class="global-section">
        <h2>自动化工作流 (UTCP)</h2>
        <p class="desc">开启后，对话时可使用工具执行命令、读写文件等；最大轮次限制单轮对话中模型可调用工具的最大轮数。</p>
        <label class="toggle-row"><input type="checkbox" id="utcpToolsEnabled" {% if utcp_tools_enabled %}checked{% endif %}> 启用自动化工作流 (UTCP)</label>
        <div style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
            <label for="utcpMaxRounds">自动化最大轮次</label>
            <input type="number" id="utcpMaxRounds" min="1" max="200" value="{{ utcp_max_tool_rounds }}" style="width: 5rem; padding: 0.4rem 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
            <span class="status-msg" id="utcpToolsStatus"></span>
        </div>
        <div style="margin-top: 0.5rem;">
            <label class="toggle-row"><input type="checkbox" id="utcpUnlimitedRounds" {% if utcp_unlimited_rounds %}checked{% endif %}> 无限任务执行轮次</label>
        </div>
        <div style="margin-top: 0.5rem;">
            <label class="toggle-row"><input type="checkbox" id="utcpUnlimitedWait" {% if utcp_unlimited_wait %}checked{% endif %}> 无限任务等待时间（单步不设超时）</label>
        </div>
        <div style="margin-top: 0.5rem;">
            <label for="utcpLongTaskSeconds">耗时超阈值(秒)则子任务横栏浅红底</label>
            <input type="number" id="utcpLongTaskSeconds" min="1" max="3600" value="{{ utcp_long_task_seconds }}" style="width: 5rem; padding: 0.4rem 0.5rem; margin-left: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
        </div>
        <div style="margin-top: 0.5rem;">
            <label class="toggle-row"><input type="checkbox" id="webPreviewEnabled" {% if web_preview_enabled %}checked{% endif %}> 启用自动化任务中的 Web 页面预览</label>
        </div>
    </section>
    <section class="global-section">
        <h2>限制器</h2>
        <p class="desc">开启后，每个对话页仅由创建时的供应商与模型维护，不可在对话中切换模型；关闭则可在同一对话中自由切换供应商与模型。</p>
        <label class="toggle-row"><input type="checkbox" id="conversationLockModel" {% if conversation_lock_model %}checked{% endif %}> 启用限制器（一个对话仅由原供应商与模型维护）</label>
        <span class="status-msg" id="conversationLockModelStatus"></span>
    </section>
    <section class="global-section">
        <h2>安全模式</h2>
        <p class="desc">开启后，AI 不可修改项目自身文件（写文件、执行会改写项目目录的命令等均会被拒绝）；上传文件不受影响。</p>
        <label class="toggle-row"><input type="checkbox" id="safeMode" {% if safe_mode %}checked{% endif %}> 开启安全模式</label>
        <span class="status-msg" id="safeModeStatus"></span>
    </section>
    <section class="global-section">
        <h2>访问安全模式</h2>
        <p class="desc">开启后，服务器每次启动时自动重新生成 HTTPS 证书（不使用预生成证书）。关闭则使用预生成证书以加快首次访问。部分功能在服务器重启后生效。</p>
        <label class="toggle-row"><input type="checkbox" id="accessSafeMode" {% if access_safe_mode %}checked{% endif %}> 启用访问安全模式</label>
        <span class="status-msg" id="accessSafeModeStatus"></span>
    </section>
    <section class="global-section">
        <h2>调试模式</h2>
        <p class="desc">开启后，在服务器控制台打印各类模块运行状态与关键运行信息，便于排查问题。部分功能在服务器重启后生效。</p>
        <label class="toggle-row"><input type="checkbox" id="debugMode" {% if debug_mode %}checked{% endif %}> 启用调试模式</label>
        <span class="status-msg" id="debugModeStatus"></span>
    </section>
    <section class="global-section">
        <h2>AI 默认回复语言</h2>
        <p class="desc">设定 AI 回复的默认语言，避免多轮工具调用后语言漂移为英文。</p>
        <div style="margin-top: 0.5rem;">
            <label for="aiDefaultLanguage">默认语言</label>
            <select id="aiDefaultLanguage" style="margin-left: 0.5rem; padding: 0.4rem 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                <option value="zh" {% if ai_default_language == 'zh' %}selected{% endif %}>中文</option>
                <option value="en" {% if ai_default_language == 'en' %}selected{% endif %}>English</option>
                <option value="auto" {% if ai_default_language == 'auto' %}selected{% endif %}>跟随用户</option>
            </select>
            <span class="status-msg" id="aiDefaultLanguageStatus"></span>
        </div>
    </section>
    <section class="global-section">
        <h2>上传文件</h2>
        <p class="desc">对话页上传的文件存放在 uploads 目录，服务器每次重启后会自动清空。此处可手动清空。</p>
        <button type="button" class="btn-check" id="btnClearUploads">清空上传文件</button>
        <span class="status-msg" id="clearUploadsStatus"></span>
    </section>
    <section class="global-section">
        <h2>AI 前置提示词</h2>
        <p class="desc">在每条对话前注入的系统提示词，用于设定 AI 角色与能力（如自动化工作流）。留空则使用内置默认说明。</p>
        <textarea id="systemPrompt" class="system-prompt-textarea" rows="6" placeholder="{{ default_system_prompt | e }}">{{ system_prompt | e }}</textarea>
        <div style="margin-top: 0.5rem;">
            <button type="button" class="btn-check" id="btnSaveSystemPrompt">保存前置提示词</button>
            <span class="status-msg" id="systemPromptStatus"></span>
        </div>
    </section>
    </div>
</div>
<script>
(function() {
    var STORAGE_KEY = 'trial_global_config_cols';
    var sectionsEl = document.getElementById('globalSections');
    var colsSelect = document.getElementById('globalLayoutCols');
    function applyCols() {
        var n = parseInt(colsSelect.value, 10) || 2;
        sectionsEl.classList.remove('cols-1', 'cols-3');
        if (n === 1) sectionsEl.classList.add('cols-1');
        else if (n === 3) sectionsEl.classList.add('cols-3');
        try { localStorage.setItem(STORAGE_KEY, String(n)); } catch (e) {}
    }
    try {
        var saved = localStorage.getItem(STORAGE_KEY);
        if (saved === '1' || saved === '3') { colsSelect.value = saved; applyCols(); }
    } catch (e) {}
    colsSelect.addEventListener('change', applyCols);

    document.getElementById('btnCheck').addEventListener('click', function() {
        var btn = this, el = document.getElementById('checkResult');
        btn.disabled = true; el.style.display = 'block'; el.innerHTML = '检测中…';
        fetch('/settings/global/api/check', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                el.innerHTML = (data.results || []).map(function(x) {
                    return '<div class="item ' + (x.ok ? 'ok' : 'err') + '">' + (x.label || '') + ': ' + (x.message || '') + '</div>';
                }).join('') || '无配置项';
            })
            .catch(function() { el.innerHTML = '<div class="item err">请求失败</div>'; })
            .finally(function() { btn.disabled = false; });
    });
    document.getElementById('utcpEnabled').addEventListener('change', function() {
        var st = document.getElementById('utcpStatus');
        fetch('/settings/global/api/utcp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ utcp_plugin_enabled: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    function saveUtcpTools() {
        var st = document.getElementById('utcpToolsStatus');
        var enabled = document.getElementById('utcpToolsEnabled').checked;
        var rounds = parseInt(document.getElementById('utcpMaxRounds').value, 10) || 50;
        rounds = Math.max(1, Math.min(200, rounds));
        var unlimitedRounds = document.getElementById('utcpUnlimitedRounds').checked;
        var unlimitedWait = document.getElementById('utcpUnlimitedWait').checked;
        var longSec = Math.max(1, Math.min(3600, parseInt(document.getElementById('utcpLongTaskSeconds').value, 10) || 10));
        fetch('/settings/global/api/utcp-tools', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ utcp_tools_enabled: enabled, utcp_max_tool_rounds: rounds, utcp_unlimited_rounds: unlimitedRounds, utcp_unlimited_wait: unlimitedWait, utcp_long_task_seconds: longSec }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    }
    document.getElementById('utcpToolsEnabled').addEventListener('change', saveUtcpTools);
    document.getElementById('utcpMaxRounds').addEventListener('change', saveUtcpTools);
    document.getElementById('utcpUnlimitedRounds').addEventListener('change', saveUtcpTools);
    document.getElementById('utcpUnlimitedWait').addEventListener('change', saveUtcpTools);
    document.getElementById('utcpLongTaskSeconds').addEventListener('change', saveUtcpTools);
    document.getElementById('webPreviewEnabled').addEventListener('change', function() {
        var st = document.getElementById('utcpToolsStatus');
        fetch('/settings/global/api/web-preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ web_preview_enabled: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('conversationLockModel').addEventListener('change', function() {
        var st = document.getElementById('conversationLockModelStatus');
        fetch('/settings/global/api/conversation-lock-model', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ conversation_lock_model: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('safeMode').addEventListener('change', function() {
        var st = document.getElementById('safeModeStatus');
        fetch('/settings/global/api/safe-mode', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ safe_mode: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('accessSafeMode').addEventListener('change', function() {
        var st = document.getElementById('accessSafeModeStatus');
        fetch('/settings/global/api/access-safe-mode', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ access_safe_mode: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存（部分功能需重启服务后生效）' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('debugMode').addEventListener('change', function() {
        var st = document.getElementById('debugModeStatus');
        fetch('/settings/global/api/debug-mode', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ debug_mode: this.checked }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存（部分功能需重启服务后生效）' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('aiDefaultLanguage').addEventListener('change', function() {
        var st = document.getElementById('aiDefaultLanguageStatus');
        var val = this.value || 'zh';
        fetch('/settings/global/api/ai-default-language', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ai_default_language: val }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
    document.getElementById('btnClearUploads').addEventListener('click', function() {
        var btn = this, st = document.getElementById('clearUploadsStatus');
        btn.disabled = true; st.textContent = '';
        fetch('/settings/global/api/clear-uploads', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            .then(function(r) { return r.json(); })
            .then(function(d) { st.textContent = d.ok ? (d.message || '已清空') : (d.error || ''); })
            .catch(function() { st.textContent = '请求失败'; })
            .finally(function() { btn.disabled = false; });
    });
    document.getElementById('btnSaveSystemPrompt').addEventListener('click', function() {
        var st = document.getElementById('systemPromptStatus');
        var text = document.getElementById('systemPrompt').value || '';
        fetch('/settings/global/api/system-prompt', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ system_prompt: text }) })
            .then(function(r) { return r.json(); }).then(function(d) { st.textContent = d.ok ? '已保存' : (d.error || ''); }).catch(function() { st.textContent = '保存失败'; });
    });
})();
</script>
{% endblock %}
